function picbackinfo(a,b){var c=a.attr("data-spec"),d=a.attr("data-type");c?pic=b.picurl+"_"+c+"x"+c+".jpg":pic=b.picurl,"carousel"==d?$("<img/>").attr("src",pic).load(function(){var b=this.width,c=this.height,d=(b/c).toFixed(2);a.find("input.img_url").attr("value",pic).trigger("input"),a.find("input.img_relratio").attr("value",d).trigger("input")}):"magic"==a.attr("data-mark")?(a.parent().prev("a").find("img").attr("src",pic),a.parent().prev("a").prev().remove(),a.parents("td").addClass("hasimg")):(c?a.find("img").attr({src:b.picurl+"_180x180.jpg"}):a.find("img").attr({src:b.picurl}),a.find("input").attr("value",pic).trigger("input"))}function selecturlback(a,b,c){var d=c.url,e=c.title;"magic"==a.attr("type")?a.parent().prev("a").attr("href",d):(a.prev().prev("input").attr("value",e).trigger("input"),a.prev("input").attr("value",d).trigger("input"))}function select_classfiyback(a,b){overall_array=[];for(var c=0;c<b.length;c++){var d={item_id:c+1,item_classfiyid:b[c].dataid,item_link:b[c].classurl,item_title:b[c].classname};overall_array.push(d)}a.prev().trigger("click")}function general_selprd(a,b,c){overall_array=[];for(var d=0;d<c.length;d++){var e=c[d].pic,e=e.replace(/80x80.jpg/,"400x400.jpg"),f={item_prdid:c[d].dataid,item_pic:e,item_title:c[d].title,item_price:c[d].price};overall_array.push(f)}prdselected_ids=b,a.prev().trigger("click")}function getformbackinfo(a,b,c,d){a.prev().val(c),a.parent().next().attr("data-id",b),overall_html=d,a.parent().next().trigger("click")}function couponchoiceinfo(a,b){overall_obj={},overall_obj={id:b.id,type:"coupon",name:b.name,num:b.num},a.prev().trigger("click")}function delicardchoiceinfo(a,b){overall_obj={},overall_obj={id:b.id,type:"delicard",name:b.cardname,num:b.cardnum},a.prev().trigger("click")}function rpacketchoiceinfo(a,b){overall_obj={},overall_obj={id:b.id,type:"rpacket",name:b.rname,num:b.rnum},a.prev().trigger("click")}function backmagazineinfo(a,b){overall_obj={},overall_obj={id:b.id,type:"mag",name:b.title,url:b.url},a.prev().trigger("click")}function resizable_location(a){var b=$(a).prev(),c=b.find("tr").find("td").length,d=b.find("tr").length;b.find(".empty").each(function(){var a=$(this).data("y");d>a&&(d=a)}),b.find(".empty[data-y="+d+"]").each(function(){var a=$(this).data("x");c>a&&(c=a)}),"0"==c?c="0px":c+="00px","0"==d?d="0px":d+="00px";var e=b.find(".empty").length;0==e?$(a).css({width:"100px",height:"100px",top:"1px",left:"1px","z-index":"98"}):$(a).css({width:"100px",height:"100px",top:d,left:c,"z-index":"100"})}function resizestart(a,b,c){var d=c.originalPosition.left,e=c.originalPosition.top;0==d||(d/=100),0==e||(e/=100);var f=0,g=0;$(a).prev().find(".empty").each(function(){var a=$(this).data("x"),b=$(this).data("y");a==d&&b>=e&&(g=b+1-e),a>=d&&b==e&&(f=a+1-d)}),$(a).resizable("option","maxHeight",100*g),$(a).resizable("option","maxWidth",100*f)}function resizestop(a,b,c){var d=String(c.originalPosition.left),e=String(c.originalPosition.top),d=d.substr(0,1),e=e.substr(0,1),f=$(a).css("width"),g=$(a).css("height"),f=f.substr(0,1),g=g.substr(0,1),h=f*g,i=parseInt(d)+parseInt(f)-1;end_y=parseInt(e)+parseInt(g)-1;var j=0;$(a).prev().find(".empty").each(function(){var a=$(this).data("x"),b=$(this).data("y");a>=d&&i>=a&&b>=e&&b<=end_y&&(j+=1)}),j!==h&&(alert("所选区域覆盖了已选的区域，请重新选择"),$(a).css({width:"100px",height:"100px"}))}var overall_array=[],overall_obj={},prdselected_ids="",overall_html="";new labelConp({action:"show",callback:function(a,b){var c="",d="";for(var e in b)c+=c?","+b[e].text:b[e].text,d+=d?";"+b[e].id:b[e].id;a.next().attr({str:c,key:d}).trigger("click"),a.attr("choosed_label",d)}}),function(a){a.extend({myTime:{CurTime:function(){return Date.parse(new Date)/1e3},DateToUnix:function(a){var b=a.split(" ",2),c=(b[0]?b[0]:"").split("-",3),d=(b[1]?b[1]:"").split(":",3);return new Date(parseInt(c[0],10)||null,(parseInt(c[1],10)||1)-1,parseInt(c[2],10)||null,parseInt(d[0],10)||null,parseInt(d[1],10)||null,parseInt(d[2],10)||null).getTime()/1e3},UnixToDate:function(a,b,c){"number"==typeof c&&(a=parseInt(a)+60*parseInt(c)*60);var d=new Date(1e3*a),e="";return e+=d.getUTCFullYear()+"-",e+=d.getUTCMonth()+1+"-",e+=d.getUTCDate(),b===!0&&(e+=" "+d.getUTCHours()+":",e+=d.getUTCMinutes()+":",e+=d.getUTCSeconds()),e}}})}(jQuery),mag.scrollbottom=function(){setTimeout(function(){var a=document.getElementById("scrolldIV");a.scrollTop=a.scrollHeight},1)},mag.showloadingtips=function(a,b){1==a?($(".loading_tips").find("i").attr("class","ui-loading-bright"),$(".ui-loading-bright").css("display","block")):(2==a?$(".loading_tips").find("i").attr("class","icon_success"):3==a&&$(".loading_tips").find("i").attr("class","icon_failed"),$(".ui-loading-bright").hide()),$(".loading_tips").addClass("show").find("div").html(b)},mag.hideloadingtips=function(){$(".loading_tips").removeClass("show")},mag.showtips=function(a,b){b||(b=3),mag.showloadingtips(b,a),setTimeout(function(){mag.hideloadingtips()},2e3)},$(function(){function a(){b=$(window).height()-238+"px",$(".viewmodalsbox").height(b)}$("input[type=radio]").live("click",function(){$(this).parent(".radiobox").addClass("active").siblings().removeClass("active")}),$(".switch_box input").live("change",function(){var a=$(this).find(".switch_info").attr("data-oninfo"),b=$(this).find(".switch_info").attr("data-offinfo"),c=$(this).parent(".switch_box");$(this).prop("checked")?(c.removeClass("off").addClass("on"),c.find(".switch_info").html(a)):(c.removeClass("on").addClass("off"),c.find(".switch_info").html(b))}),$(".switch_box").live("hover",function(a){var b=$(this).find(".switch_info").attr("data-oninfo"),c=$(this).find(".switch_info").attr("data-offinfo"),d=$(this).find(".switch_info");$(this).hasClass("on")?"mouseenter"==a.type?d.html(c):d.html(b):"mouseenter"==a.type?d.html(b):d.html(c)}),$(".accordion-toggle").click(function(){var a=$(this).attr("data-parent");$(this).parent().next().hasClass("in")?$(this).find("i").removeClass("icon_downarrow").addClass("icon_rightarrow"):($(".accordion-toggle[data-parent="+a+"]").find("i").removeClass("icon_downarrow").addClass("icon_rightarrow"),$(this).find("i").removeClass("icon_rightarrow").addClass("icon_downarrow"))});var b;$(window).bind("load",function(){a()}),$(window).bind("resize",function(){a()})}),myApp.directive("maincon",function(){return{restrict:"E",templateUrl:mag.templateurl,controller:"mainCtr",replace:!0}}),myApp.directive("actcon",function(){return{restrict:"E",templateUrl:mag.act_url}}),myApp.filter("decodeURI",["$sce",function(a){return function(b){try{return myVal=decodeURIComponent(b),a.trustAsHtml(myVal)}catch(c){return myVal=encodeURIComponent(b),a.trustAsHtml(decodeURIComponent(myVal))}}}]),myApp.filter("to_trusted",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),myApp.filter("setpuzzle",["$sce",function(a){return function(b){var c=decodeURIComponent(b),d='<div class="magic_btns"><span class="edit_magicurl selecturl" data-mark="backurl" type="magic" title="选择链接"></span><span class="edit_magicimg selectimage" data-mark="magic" title="选择图片"></span><span class="del_magic" title="删除"></span></div>',e="";return $(c).find("tr").each(function(){var a=$(this).find("td.notempty").length;a>0&&$(this).find("td.notempty").append(d);var b="<tr>"+$(this).html()+"</tr>";e+=b}),a.trustAsHtml(e)}}]),myApp.directive("slider",function(){return{restrict:"A",link:function(a,b,c){$(b).slider({range:"min",min:parseInt(c.min),max:parseInt(c.max),step:parseInt(c.step),value:parseInt(c.value),slide:function(b,d){var e=c.type,f=d.value;dragvalue=f+"px",a.$apply(function(){c.mark?a.$storage.form[c.mark]=dragvalue:a.field[e]=dragvalue})}})}}}),myApp.directive("colorpicker",function(){return{restrict:"A",link:function(a,b,c){var d=c.type;$(b).colorpicker({customClass:"colorpicker-big",color:c.color,sliders:{saturation:{maxLeft:130,maxTop:130},hue:{maxTop:130},alpha:{maxTop:130}}}).on("changeColor.colorpicker",function(b){a.$apply(function(){var e=b.color.toRGB().r,f=b.color.toRGB().g,g=b.color.toRGB().b,h=b.color.toRGB().a,i="rgba("+e+","+f+","+g+","+h+")";if("mag"==c.mark)a.$storage.form.bgcolor=i;else if("act"==c.mark)a.$storage.form.styles[d]=i;else if("wheel"==c.mark){a.field[d]=i;var j=[a.field.field_bgcolor1,a.field.field_bgcolor2];wheelfunc.draw(j,a.field.field_color)}else a.field[d]=i;modalheight=$(window).height()-238+"px",$(".viewmodalsbox").height(modalheight)})})}}}),myApp.directive("addtoueditor",function(){return{restrict:"A",link:function(a,b,c){$(b).click(function(){var c=$(b).html();a.ueditor.execCommand("insertHtml",c)})}}}),myApp.directive("limitcount",function(){return{restrict:"A",link:function(a,b,c){InitLimit(b,c.count,!0,function(a){if(a>=0)$(b).next().children().html(a).attr("style","");else{var d=$.trim($(b).val()),e=getByteVal(d,c.count);$(b).val(e).trigger("input"),$(b).next().children().attr("style","color:#ff0000")}})}}}),myApp.directive("acttime",function(){return{restrict:"A",link:function(a,b,c){$(b).focus(function(){WdatePicker({skin:"whyGreen",dateFmt:"yyyy-MM-dd HH:mm:ss",minDate:"%y-%M-%d %H:%m:%s",readOnly:!0,onpicked:function(b){a.$apply(function(){a.$storage.form.rules[c.mark]=b.cal.getNewDateStr()})}})})}}}),myApp.directive("wdatetime",function(){return{restrict:"A",link:function(a,b,c){$(b).focus(function(){WdatePicker({skin:"whyGreen",dateFmt:"yyyy-MM-dd HH:mm:ss",minDate:"%y-%M-%d %H:%m:%s",readOnly:!0,onpicked:function(b){a.$apply(function(){var d=$.myTime.DateToUnix(b.cal.getNewDateStr());a.field.field_rtime=b.cal.getNewDateStr(),a.field[c.mark]=d;var e=new Date,f=e.getTime()-mag.serverTime,g=new Date(1e3*parseInt(d)),h=(g.getTime(),new Date),i=g.getTime()-h.getTime()+f,j=Math.floor(i/864e5),k=Math.floor(i/36e5)%24,l=Math.floor(i/6e4)%60,m=Math.floor(i/1e3)%60;a.field.field_days=j,a.field.field_hours=k,a.field.field_minutes=l,a.field.field_seconds=m})}})})}}}),myApp.config(function(a,b){b.when("","/title"),a.state("title",{url:"/title",views:{richmodal:{templateUrl:mag.getrichmodaltempurl+"title"}}}).state("content",{url:"/content",views:{richmodal:{templateUrl:mag.getrichmodaltempurl+"content"}}}).state("attention",{url:"/attention",views:{richmodal:{templateUrl:mag.getrichmodaltempurl+"attention"}}}).state("line",{url:"/line",views:{richmodal:{templateUrl:mag.getrichmodaltempurl+"line"}}}).state("readmore",{url:"/readmore",views:{richmodal:{templateUrl:mag.getrichmodaltempurl+"readmore"}}}).state("share",{url:"/share",views:{richmodal:{templateUrl:mag.getrichmodaltempurl+"share"}}}).state("pushother",{url:"/pushother",views:{richmodal:{templateUrl:mag.getrichmodaltempurl+"pushother"}}})}),myApp.service("ColorService",function(){var a={bgcolor:"#f8f7f5",title:{stylecolor:"#ff5d5d",bgcolor:"rgba(255,255,255,0)",color:"#333333"},richtxt:{color:"#00BBEC",bgcolor:"transparent"},carousel:{bgcolor:"transparent"},imglist:{bgcolor:"rgba(255,255,255,0)"},btnlink:{bgcolor:"#ff5d5d",color:"#fff",bordercolor:"#ff5d5d"},division:{bordercolor:"#333"},notice:{bgcolor:"#ff5d5d",color:"#fff"},contact:{bgcolor:"#ff5d5d",color:"#fff",phonecolor:"#fff"},menu:{bgcolor:"#f0f0f0",color:"#777",bordercolor:"#dfdfdf"},product:{bgcolor:"transparent"},classfiy:{bgcolor:"#fff",color:"#333",bordercolor:"#ddd"},time:{bgcolor:"#ff5d5d",color:"#fff",timebgcolor:"#333",timefcolor:"#fff"},qrcode:{bgcolor:"#fff",shadowcolor:"rgba(0,0,0,0.5)"}},b=function(a,b,c){return a[b]=a.splice(c,1,a[b])[0],a};return{color:a,addfield:function(b,c){var d={};switch(b){case"title":d={field_id:c,field_type:b,field_con:"标题文字",field_fz:"14px",field_style:"zero",field_stylecolor:a[b].stylecolor,field_align:"center",field_isbold:"bold",field_isindent:"0em",field_bgcolor:a[b].bgcolor,field_color:a[b].color,field_pt:"8px",field_pr:"5px",field_pb:"8px",field_pl:"5px",field_mt:"0px",field_mb:"8px"};break;case"richtxt":d={field_id:c,field_type:b,field_richcon:"",field_color:a[b].color,field_bgcolor:a[b].bgcolor,field_pt:"0px",field_pr:"0px",field_pb:"0px",field_pl:"0px"};break;case"carousel":d={field_id:c,field_type:b,field_bgcolor:a[b].bgcolor,field_showtitle:"hidetitle",field_imgs:[{img_id:1,img_url:"http://img.midite.com/image_spaces/07/d3/56/33/1436933895901.jpg",img_link:"",img_linktitle:"",img_title:"图片标题",img_relratio:"1.78"},{img_id:2,img_url:"http://img.midite.com/image_spaces/07/d3/56/33/1436933895901.jpg",img_link:"",img_linktitle:"",img_title:"图片标题",img_relratio:"1.78"}],field_pt:"0px",field_pr:"0px",field_pb:"0px",field_pl:"0px",field_mt:"0px",field_mb:"0px"};break;case"imglist":d={field_id:c,field_type:b,field_bgcolor:a[b].bgcolor,field_showtitle:"hide",field_arrange:"one",field_imgs:[{img_id:1,img_url:"http://img.midite.com/image_spaces/07/d3/56/33/143693389572.jpg",img_link:"",img_linktitle:"",img_title:"图片标题"}],field_imgspace:"0px",field_pt:"0px",field_pr:"0px",field_pb:"0px",field_pl:"0px",field_mt:"0px",field_mb:"8px"};break;case"puzzle":d={field_id:c,field_type:b,field_puzzlecon:"",field_pt:"0px",field_pr:"0px",field_pb:"0px",field_pl:"0px",field_mt:"0px",field_mb:"8px"};break;case"btnlink":d={field_id:c,field_type:b,field_con:"连接按钮",field_fz:"14px",field_bgcolor:a[b].bgcolor,field_color:a[b].color,field_bordercolor:a[b].bordercolor,field_isblock:"block",field_align:"center",field_pt:"4px",field_pr:"12px",field_pb:"4px",field_pl:"12px",field_mt:"5px",field_mr:"5px",field_mb:"5px",field_ml:"5px"};break;case"division":d={field_id:c,field_type:b,field_bordertype:"solid",field_borderwidth:"1px",field_bordercolor:a[b].bordercolor,field_blank:"20px",field_mt:"10px",field_mr:"5px",field_mb:"10px",field_ml:"5px"};break;case"notice":d={field_id:c,field_type:b,field_con:"公告：自即日起本店...",field_fz:"12px",field_bgcolor:a[b].bgcolor,field_color:a[b].color,field_slide:"left",field_pt:"4px",field_pr:"12px",field_pb:"4px",field_pl:"12px",field_mt:"0px",field_mb:"0px"};break;case"contact":d={field_id:c,field_type:b,field_fz:"14px",field_modal:"1",field_tel:"400-123-45678",field_con:"联系我们",field_bgcolor:a[b].bgcolor,field_color:a[b].color,field_phonefz:"16px",field_phonecolor:a[b].phonecolor,field_pt:"8px",field_pr:"8px",field_pb:"8px",field_pl:"8px",field_mt:"0px",field_mb:"8px"};break;case"menu":d={field_id:c,field_type:b,field_bgcolor:a[b].bgcolor,field_color:a[b].color,field_bordercolor:a[b].bordercolor,field_fz:"12px",field_iconsize:"20px",field_imgsize:"20px",field_navs:[{nav_id:1,nav_imgurl:"",nav_link:mag.home_link,nav_linktitle:"首页",nav_title:"首页"},{nav_id:2,nav_imgurl:"",nav_link:mag.classify_link,nav_linktitle:"分类",nav_title:"分类"},{nav_id:3,nav_imgurl:"",nav_link:mag.shopping_cat_link,nav_linktitle:"购物车",nav_title:"购物车"},{nav_id:4,nav_imgurl:"",nav_link:mag.personal_link,nav_linktitle:"个人中心(订单页面)",nav_title:"个人中心"}],field_pt:"8px",field_pb:"8px"};break;case"share":d={field_id:c,field_type:b,field_style:"default",field_shareimg:IMAGEPATH+"/components/img/wxdiytools/share2.jpg",field_pl:"0px",field_pr:"0px",field_mt:"8px",field_mb:"8px"};break;case"product":d={field_id:c,field_type:b,field_prdtheme:"defaultskin",field_themetitle:"默认主题",field_bgcolor:a[b].bgcolor,field_showcart:"nocart",field_makeup:"mod-two-title",field_items:"",field_prdids:"",field_pt:"0px",field_pr:"0px",field_pb:"0px",field_pl:"0px",field_mt:"0px",field_mb:"8px"};break;case"classfiy":d={field_id:c,field_type:b,field_bgcolor:a[b].bgcolor,field_color:a[b].color,field_bordercolor:a[b].bordercolor,field_fz:"12px",field_lineh:"38px",field_items:"",field_pr:"8px",field_pl:"8px",field_mt:"0px",field_mb:"8px"};break;case"time":d={field_id:c,field_type:b,field_fz:"14px",field_con:"距离活动开始还有",field_bgcolor:a[b].bgcolor,field_color:a[b].color,field_size:"18px",field_timebgcolor:a[b].timebgcolor,field_timefz:"12px",field_timefcolor:a[b].timefcolor,field_time:"",field_rtime:"",field_pt:"8px",field_pr:"0px",field_pb:"8px",field_pl:"0px",field_mt:"0px",field_mb:"8px"};break;case"form":d={field_id:c,field_type:b,field_formid:"",field_formcon:"",field_pt:"30px",field_pr:"10px",field_pb:"30px",field_pl:"10px",field_mt:"0px",field_mb:"0px"};break;case"video":d={field_id:c,field_type:b,field_video:"",field_mt:"0px",field_mb:"8px"};break;case"qrcode":d={field_id:c,field_type:b,field_bgcolor:a[b].bgcolor,field_isshadow:0,field_shadowsize:"5px",field_shadowcolor:a[b].shadowcolor,field_pt:"10px",field_pb:"10px",field_mt:"0px",field_mb:"0px"}}return d},addcarouselimg:function(a){for(var b=0,c=0;c<a.field_imgs.length;c++){var d=a.field_imgs[c].img_id;d>b&&(b=d)}if("carousel"==a.field_type)var e="http://img.midite.com/image_spaces/07/d3/56/33/1436933895901.jpg";else var e="http://img.midite.com/image_spaces/07/d3/56/33/143693389572.jpg";var f={img_id:b+1,img_url:e,img_link:"",img_linktitle:"",img_title:"图片标题"};"carousel"==a.field_type&&(f.img_relratio="1.78"),a.field_imgs.push(f)},del_carousel:function(a,b){var c=a.field_imgs.length;if("carousel"==a.field_type){if(2>=c)return mag.showtips("轮播图应保留2-5张图片"),!1}else if(1>=c)return mag.showtips("至少要保留一张图片"),!1;for(var d=0;d<a.field_imgs.length;d++)if(a.field_imgs[d].img_id==b.img_id){a.field_imgs.splice(d,1);break}},addmenu_nav:function(a){for(var b=0,c=0;c<a.field_navs.length;c++){var d=a.field_navs[c].nav_id;d>b&&(b=d)}var e={nav_id:b+1,nav_imgurl:"",nav_link:"",nav_title:""};a.field_navs.push(e)},del_nav:function(a,b){var c=a.field_navs.length;if(2>=c)return mag.showtips("菜单至少要有两项"),!1;for(var d=0;d<a.field_navs.length;d++)if(a.field_navs[d].nav_id==b.nav_id){a.field_navs.splice(d,1);break}},show_menusetimg:function(a){for(var b=0,c=0;c<a.field_navs.length;c++)a.field_navs[c].nav_imgurl&&b++;return b>0?!0:!1},richConfig:{toolbars:[["fontsize","|","blockquote","horizontal","|","inserttable","localimages","map","emotion","date","fullscreen","|","source"],["bold","italic","underline","strikethrough","forecolor","backcolor","|","justifyleft","justifycenter","justifyright","|","indent","|","rowspacingtop","rowspacingbottom","lineheight","|","insertorderedlist","insertunorderedlist","|","imagenone","imageleft","imageright","imagecenter","|","customstyle","paragraph","fontfamily","|","removeformat","link","unlink"]],autoClearinitialContent:!0,allowDivTransToP:!1,autotypeset:{removeEmptyline:!0},wordCount:!1,elementPathEnabled:!1,enableAutoSave:!1,initialFrameWidth:350,initialFrameHeight:450,autoFloatEnabled:!1,topOffset:0,zIndex:1060,autoHeightEnabled:!1,labelMap:{localimages:"选择微相册图片"},iframeUrlMap:{localimages:MAINHOST+"/shangjia/commoncomponent/ueditorimg"}},upmove_modal:function(a,c){0!=c&&b(a,c,c-1)},downmove_modal:function(a,c){c!=a.length-1&&b(a,c,c+1)}}}),myApp.service("ActivityService",function(){var a={1:"dazhuanpan",3:"goldegg",4:"tiger",7:"shaking"},b={1:"大转盘",3:"砸金蛋",4:"老虎机",7:"摇一摇"},c={1:[{name:"神秘黑",value:"black"},{name:"冰雪蓝",value:"white"},{name:"激情红",value:"red"},{name:"柠檬黄",value:"yellow"},{name:"幽海蓝",value:"blue"},{name:"森林绿",value:"green"}],7:[{name:"高贵紫",value:"purple"},{name:"2016",value:"newred"}]},d={black:{major:{bg_img:IMAGEPATH+"/micromagazine/img/dzp/black.png",bg_color:"#262626",color_1:"#ffffff",color_2:"#e20000",share_img:IMAGEPATH+"/micromagazine/img/dzp/share-zp.png"},wheel:{theme:"black",bgcolor1:"#718eeb",bgcolor2:"#9fb4f5",color:"#fff"}},white:{major:{bg_img:IMAGEPATH+"/micromagazine/img/dzp/white.png",bg_color:"#ffffff",color_1:"#333333",color_2:"#e20000",share_img:IMAGEPATH+"/micromagazine/img/dzp/share-zp.png"},wheel:{theme:"white",bgcolor1:"#718eeb",bgcolor2:"#9fb4f5",color:"#fff"}},red:{major:{bg_img:IMAGEPATH+"/micromagazine/img/dzp/black.png",bg_color:"#e5423e",color_1:"#ffeeb9",color_2:"#FFB149",share_img:IMAGEPATH+"/micromagazine/img/dzp/share-zp.png"},wheel:{theme:"red",bgcolor1:"#ff5959",bgcolor2:"#ff7f7e",color:"#fff"}},yellow:{major:{bg_img:IMAGEPATH+"/micromagazine/img/dzp/yellow.png",bg_color:"#FBE43C",color_1:"#bc5c00",color_2:"#e20000",share_img:IMAGEPATH+"/micromagazine/img/dzp/share-zp.png"},wheel:{theme:"yellow",bgcolor1:"#EFD939",bgcolor2:"#FBE43C",color:"#bc5c00"}},blue:{major:{bg_img:IMAGEPATH+"/micromagazine/img/dzp/black.png",bg_color:"#0a8af2",color_1:"#ffffff",color_2:"#CCFCFC",share_img:IMAGEPATH+"/micromagazine/img/dzp/share-zp.png"},wheel:{theme:"blue",bgcolor1:"#097AD6",bgcolor2:"#0a8af2",color:"#fff"}},green:{major:{bg_img:IMAGEPATH+"/micromagazine/img/dzp/green.png",bg_color:"#06bf04",color_1:"#ffffff",color_2:"#FCFF94",share_img:IMAGEPATH+"/micromagazine/img/dzp/share-zp.png"},wheel:{theme:"green",bgcolor1:"#05A904",bgcolor2:"#06bf04",color:"#FCFF94"}}},e={purple:{major:{bg_img:IMAGEPATH+"/micromagazine/img/shaking/purplebg.jpg",hand_img:IMAGEPATH+"/micromagazine/img/shaking/purple_hand.png",wheel_img:IMAGEPATH+"/micromagazine/img/shaking/purple_wheel.png",shade_img:IMAGEPATH+"/micromagazine/img/shaking/purple_shade.png",bg_color:"#820fb7",color_1:"#fff",color_2:"#a20503",color_3:"#fff",share_img:IMAGEPATH+"/micromagazine/img/shaking/share_shake.jpg"}},newred:{major:{bg_img:IMAGEPATH+"/micromagazine/img/shaking/newred_bg.gif",hand_img:IMAGEPATH+"/micromagazine/img/shaking/newred_hand.png",wheel_img:IMAGEPATH+"/micromagazine/img/shaking/newred_wheel.png",shade_img:IMAGEPATH+"/micromagazine/img/shaking/newred_shade.png",bg_color:"#b6004f",color_1:"#29a6f4",color_2:"#fff",color_3:"#fff",share_img:IMAGEPATH+"/micromagazine/img/shaking/newred_share.jpg"}}},f={gold:{major:{bg_img:IMAGEPATH+"/micromagazine/img/egg/gold_bg.png",bg_color:"#04e578",color_1:"#fff",color_2:"#FF6E06",share_img:IMAGEPATH+"/micromagazine/img/egg/gold_eggshare.jpg",egg_img:IMAGEPATH+"/micromagazine/img/egg/gold_egg.png",eggbreak_img:IMAGEPATH+"/micromagazine/img/egg/gold_eggbreak.png",egglight_img:IMAGEPATH+"/micromagazine/img/egg/gold_light.png",eggpeng_img:IMAGEPATH+"/micromagazine/img/egg/gold_peng.png",eggprize_img:IMAGEPATH+"/micromagazine/img/egg/gold_prize.png",eggbrick_img:IMAGEPATH+"/micromagazine/img/egg/gold_brick.png",eggwin_img:IMAGEPATH+"/micromagazine/img/egg/eggwin.png"}}},g={},h={1:[{field_id:1,field_type:a[1],field_theme:"black",field_bgcolor1:d.black.wheel.bgcolor1,field_bgcolor2:d.black.wheel.bgcolor2,field_color:d.black.wheel.color},{field_id:2,field_type:a[1],field_prize:"0"},{field_id:3,field_type:a[1],field_info:"text",field_infoimg:IMAGEPATH+"/micromagazine/img/dzp/wheelinfo.png"}],7:[{field_id:1,field_type:a[7],field_theme:"purple",field_handimg:e.purple.major.hand_img,field_wheelimg:e.purple.major.wheel_img,field_shadeimg:e.purple.major.shade_img,field_bgcolor:e.purple.major.bg_color,field_color1:e.purple.major.color_1,field_color2:e.purple.major.color_2,field_color3:e.purple.major.color_3}],3:[{field_id:1,field_type:a[3],field_theme:"gold",field_color1:f.gold.major.color_1,field_color2:f.gold.major.color_2},{field_id:2,field_type:a[3],field_prize:"0"},{field_id:3,field_type:a[3],field_info:"text",field_infoimg:IMAGEPATH+"/micromagazine/img/dzp/wheelinfo.png"}]},i=({1:{field_type:a[1],theme:"black",title:"欢乐大转盘",iscode:!1,code:"",starttime:"",endtime:"",numtype:"only",num:"1",labeltag:{id:"",name:""},themetxt:"",describe:"",commonshare:"轻松中大奖，小伙伴们都来看看哦~~",awardshare:"我中了#奖品#，小伙伴们也来玩啊！",loseshare:"轻松中大奖，小伙伴们都来看看哦~~",awardinfo:"恭喜你中奖了!",loseinfo:"真遗憾没中奖，要努力啊！",prize:[{name:"",rate:"",num:"",type:"",award:""}]}},{1:{field_type:a[1],bgimg:d.black.major.bg_img,bgcolor:d.black.major.bg_color,color1:d.black.major.color_1,color2:d.black.major.color_2,shareimg:d.black.major.share_img},7:{field_type:a[7],bgimg:e.purple.major.bg_img,bgcolor:e.purple.major.bg_color,shareimg:e.purple.major.share_img},3:{field_type:a[3],bgimg:f.gold.major.bg_img,bgcolor:f.gold.major.bg_color,color1:f.gold.major.color_1,color2:f.gold.major.color_2,shareimg:f.gold.major.share_img,eggimg:f.gold.major.egg_img,breakimg:f.gold.major.eggbreak_img,lightimg:f.gold.major.egglight_img,pengimg:f.gold.major.eggpeng_img,prizeimg:f.gold.major.eggprize_img,brickimg:f.gold.major.eggbrick_img,winimg:f.gold.major.eggwin_img}});return{actname:a,actnamez:b,activity:h,actthemename:c,getrules:function(b){var c={1:{theme:"black",name:"大转盘",title:"欢乐大转盘"},7:{theme:"purple",name:"摇一摇",title:"开心摇一摇"},3:{theme:"gold",name:"砸金蛋",title:"疯狂砸金蛋"}},d={field_type:a[b],theme:c[b].theme,name:c[b].name,title:c[b].title,iscode:!1,code:"",starttime:"",endtime:"",numtype:"only",num:"1",labeltag:{id:"",name:""},themetxt:"",describe:"",commonshare:"轻松中大奖，小伙伴们都来看看哦~~",awardshare:"我中了#奖品#，小伙伴们也来玩啊！",loseshare:"轻松中大奖，小伙伴们都来看看哦~~",awardinfo:"恭喜你中奖了!",loseinfo:"真遗憾没中奖，要努力啊！",prize:[{name:"",rate:"",num:"",type:"",award:""}]};return d},styles:i,getacttheme:function(a){var b;switch(a){case"1":b=d;break;case"3":b=f;break;case"4":b=g;break;case"7":b=e}return b},numtype_opt:[{value:"only",text:"只"},{value:"day",text:"每天"}],num_opt:["1","2","3","4","5","6","7","8","9","10"],prizetype_opt:[{value:"0",text:"实物奖品"},{value:"1",text:"优惠券"},{value:"2",text:"积分"},{value:"3",text:"提货卡"},{value:"4",text:"店铺红包"},{value:"5",text:"自定义"},{value:"6",text:"补签机会"}],delprize:function(a,b){var c=a.length;if(1>=c)return mag.showtips("至少要有一个奖项"),!1;for(var d=0;c>d;d++)if(d==b){a.splice(d,1);break}},addprize:function(a){var b={name:"",rate:"",num:"",type:"",award:""};a.push(b)},changedzptheme:function(a,b){a.styles.bgimg=d[b].major.bg_img,a.styles.bgcolor=d[b].major.bg_color,a.styles.color1=d[b].major.color_1,a.styles.color2=d[b].major.color_2,a.rules.theme=b;for(var c=0;c<a.form_fields.length;c++)"1"==a.form_fields[c].field_id&&(a.form_fields[c].field_theme=d[b].wheel.theme,a.form_fields[c].field_bgcolor1=d[b].wheel.bgcolor1,a.form_fields[c].field_bgcolor2=d[b].wheel.bgcolor2,a.form_fields[c].field_color=d[b].wheel.color);var e=[d[b].wheel.bgcolor1,d[b].wheel.bgcolor2];wheelfunc.draw(e,d[b].wheel.color);var f=$(window).height()-238+"px";$(".viewmodalsbox").height(f)},changeshaketheme:function(a,b){a.styles.bgimg=e[b].major.bg_img,a.styles.bgcolor=e[b].major.bg_color,a.styles.shareimg=e[b].major.share_img,a.rules.theme=b;for(var c=0;c<a.form_fields.length;c++)"1"==a.form_fields[c].field_id&&(a.form_fields[c].field_handimg=e[b].major.hand_img,a.form_fields[c].field_wheelimg=e[b].major.wheel_img,a.form_fields[c].field_shadeimg=e[b].major.shade_img,a.form_fields[c].field_bgcolor=e[b].major.bg_color,a.form_fields[c].field_color1=e[b].major.color_1,a.form_fields[c].field_color2=e[b].major.color_2,a.form_fields[c].field_color3=e[b].major.color_3,a.form_fields[c].field_theme=b);var d=$(window).height()-238+"px";$(".viewmodalsbox").height(d)}}}),myApp.service("SaveService",function SaveService(){var validatemagazine=function(a,b){var c=a.$storage.form,d=c.form_fields;if("mgz"==b){var e=c.share,f=e.shareimg,g=e.sharetitle,h=e.sharecontent;if(d.length<=0)return mag.showtips("请添加微杂志内容"),a.clicklock=0,!1;if(!g||!h)return mag.showtips("请填写微杂志分享内容"),a.showsetmagazine(),a.clicklock=0,!1;if(!f)return mag.showtips("请选择微杂志分享图片"),a.showsetmagazine(),a.clicklock=0,!1}for(var i=0;i<d.length;i++){var j=d[i].field_type,k=d[i].field_id;switch(j){case"richtxt":if(!d[i].field_richcon)return mag.showtips("富文本内容不能为空"),a.showcurrentitem(j,k),a.clicklock=0,!1;break;case"carousel":for(var l=d[i].field_imgs,m=l[0].img_relratio,n=0;n<l.length;n++){var o=l[n].img_relratio;if(m!=o){var p=parseInt(n)+1;return mag.showtips("轮播图第"+p+"张尺寸不对，请重新选择图片"),a.showcurrentitem(j,k),a.clicklock=0,!1}}break;case"puzzle":if(!d[i].field_puzzlecon)return mag.showtips("拼图内容不能为空"),a.showcurrentitem(j,k),a.clicklock=0,!1;break;case"product":if(d[i].field_items.length<=0)return mag.showtips("商品模块为空，请选择商品"),a.showcurrentitem(j,k),a.clicklock=0,!1;break;case"classfiy":if(d[i].field_items.length<=0)return mag.showtips("关联分类模块为空，请选择关联分类"),a.showcurrentitem(j,k),a.clicklock=0,!1;break;case"time":if(!d[i].field_time)return mag.showtips("倒计时的时间不能为空"),a.showcurrentitem(j,k),a.clicklock=0,!1;break;case"form":if(!d[i].field_formid)return mag.showtips("请选择表单"),a.showcurrentitem(j,k),a.clicklock=0,!1;break;case"video":if(!d[i].field_url)return mag.showtips("请填写视频连接并生成"),a.showcurrentitem(j,k),a.clicklock=0,!1}}return!0},isRate=function(a){var b="^\\d+(\\.\\d+)?$",c=new RegExp(b);return-1!=a.search(c)?!0:!1},savebackfunc=function(a,b,c){if(0==a.code)mag.showloadingtips(2,a.tip),c.clearsession(),setTimeout(function(){mag.hideloadingtips(),window.location.href=b},1e3);else if(1==a.code)if(2==a.err_type)mag.showloadingtips(3,a.tip),setTimeout(function(){mag.hideloadingtips()},2e3);else if(1==a.err_type){var d=a.type,e="",f=a.field_id;switch(d){case"act":e=a.tip;break;case"content":e="请添加微杂志内容";break;case"setshare":e="请填写微杂志分享内容";break;case"richtxt":e="富文本内容不能为空";break;case"carousel":e="轮播图尺寸不对，请选择尺寸一样或者比例一样的图片";break;case"puzzle":e="拼图内容不能为空";break;case"product":e="商品模块为空，请选择商品";break;case"classfiy":e="关联分类模块为空，请选择关联分类";break;case"time":e="倒计时的时间不能为空";break;case"form":e="请选择表单";break;case"video":e="请填写视频连接并生成"}c.$apply(function(){"setshare"==d||"act"==d?c.showsetmagazine():"content"!=d&&c.showcurrentitem(d,f)}),mag.showtips(e)}},savecommonmag=function($scope){if(validatemagazine($scope,"mgz")){if(mag.isedit)var data={content:$scope.$storage.form,id:mag.isedit};else var data={content:$scope.$storage.form};$.ajax({type:"post",data:data,url:mag.savemagazine,beforeSend:function(){mag.showloadingtips(1,"保存中，请稍后...")},success:function(msg){$scope.clicklock=0;var data=eval("("+msg+")"),link=mag.magazinelisturl;savebackfunc(data,link,$scope)}})}};return{previewmagazine:function(a){validatemagazine(a,"mgz")&&$("#previewmag").modal("show")},confirm_preview:function($scope,$timeout){if(validatemagazine($scope,"mgz")){if(!$scope.nick)return $scope.$apply(function(){$scope.previewtip=!0,$scope.previewinfo="昵称不能为空",$scope.previewstatus="red",$timeout(function(){$scope.previewtip=!1},2e3)}),$("#wx_nick").focus(),!1;$.ajax({type:"POST",url:mag.previewUrl,data:{str:$scope.$storage.form,nick:$scope.nick,type:6,mgzname:$scope.$storage.form.share.sharetitle},success:function(msg){var data=eval("("+msg+")");$scope.$apply(function(){$scope.previewtip=!0,$scope.previewinfo=data.reason,1==data.status?$scope.previewstatus="red":$scope.previewstatus="green",$timeout(function(){$scope.previewtip=!1},2e3)})}})}},savemagazine:function($scope){var savetype=$scope.$storage.form.type;if("magazine"==savetype)savecommonmag($scope);else if("magazine"!==savetype){var rules=$scope.$storage.form.rules,patrn=/[`~!@#$%^&*()_+?:"{}\/;'[\]]/im,jfpatrn=/^[0-9]*[1-9][0-9]*$/,mountpatrn=/^[0-9]*[0-9][0-9]*$/;if(!rules.title||patrn.test(rules.title))return mag.showtips("活动标题不能为空且不能含有非法字符"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if("true"==rules.iscode&&(!rules.code||!jfpatrn.test(rules.code)||rules.code.length>5))return mag.showtips("积分值不能为空，必须是长度小于6的正整数"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.starttime)return mag.showtips("活动开始时间不能为空"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.endtime)return mag.showtips("活动结束时间不能为空"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(rules.starttime>rules.endtime)return mag.showtips("活动开始时间不能晚于结束时间"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.themetxt||patrn.test(rules.themetxt))return mag.showtips("活动主题不能为空且不能含有非法字符"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.describe)return mag.showtips("活动描述不能为空且小于500字"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.commonshare)return mag.showtips("活动普通分享内容不能为空"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.awardshare)return mag.showtips("活动中奖分享内容不能为空"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.loseshare)return mag.showtips("活动未中奖分享内容不能为空"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.awardinfo)return mag.showtips("活动中奖提示文字不能为空"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!rules.loseinfo)return mag.showtips("活动未中奖提示文字不能为空"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(rules.prize.length>0)for(var rates=0,i=0;i<rules.prize.length;i++){var current=rules.prize[i];if(rates=parseFloat(rates)+parseFloat(rules.prize[i].rate),!current.name||patrn.test(current.name))return mag.showtips("奖品"+(i+1)+"名不能为空且不能含有非法字符"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!current.rate||current.rate<.01||current.rate>=100)return mag.showtips("奖品"+(i+1)+"中奖率不能为空应在0.01%-100%之间"),$scope.showsetmagazine(),$scope.clicklock=0,
!1;if(!isRate(current.rate))return mag.showtips("奖品"+(i+1)+"中奖率格式不对"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(rates.toFixed(2)>100)return mag.showtips("中奖率之和应该小于100！"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(current.num.length>100||!mountpatrn.test(current.num))return mag.showtips("奖品"+(i+1)+"数量必须是非负整数且长度小于100位"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if(!current.type)return mag.showtips("奖品"+(i+1)+"请选择一种奖品类型"),$scope.showsetmagazine(),$scope.clicklock=0,!1;if("1"==current.type||"3"==current.type||"4"==current.type){var num=current.award.num,arr={1:"优惠券",3:"提货卡",4:"店铺红包"};if(parseInt(num)<parseInt(current.num))return mag.showtips("奖品"+(i+1)+"选择的"+arr[current.type]+"数量不能小于奖品数量"),$scope.showsetmagazine(),$scope.clicklock=0,!1}else if("2"==current.type||"6"==current.type){var val=current.award.value,arr={2:"积分",6:"补签机会"};if(!jfpatrn.test(val))return mag.showtips("奖品"+(i+1)+"填写的"+arr[current.type]+"数量必须是正整数"),$scope.showsetmagazine(),$scope.clicklock=0,!1}else if("5"==current.type){var id=current.award.id;if(!id)return mag.showtips("奖品"+(i+1)+"请选择自定义的奖项"),$scope.showsetmagazine(),$scope.clicklock=0,!1}}if(validatemagazine($scope,"act")){if(mag.isedit)var data={content:$scope.$storage.form,act_kind:mag.act_type,id:mag.isedit};else var data={content:$scope.$storage.form,act_kind:mag.act_type};$.ajax({type:"post",data:data,url:mag.saveactivity,beforeSend:function(){mag.showloadingtips(1,"保存中，请稍后...")},success:function(msg){$scope.clicklock=0;var data=eval("("+msg+")"),link=data.skip_link;savebackfunc(data,link,$scope)}})}}}}}),myApp.controller("mainCtr",["$scope","$sessionStorage","$timeout","ColorService","ActivityService","SaveService",function(a,b,c,d,e,f){if(a.diyboxHeight=$(window).height()-238+"px",a.color=d.color,mag.isact&&(a.actname=e.actname,a.actnamez=e.actnamez,a.act=e.activity,a.rules=e.getrules(mag.act_type),a.styles=e.styles,a.actthemename=e.actthemename,a.acttheme=e.getacttheme(mag.act_type),a.act_name=a.actname[mag.act_type],a.act_themename=a.actthemename[mag.act_type],a.numtype_opt=e.numtype_opt,a.num_opt=e.num_opt,a.prizetype_opt=e.prizetype_opt),mag.isedit){for(var g=0,h=0;h<mag.data.content.form_fields.length;h++){var i=mag.data.content.form_fields[h];g=parseInt(i.field_id)>=parseInt(g)?i.field_id:g}a.$storage=b.$default({showmagazineset:!0,lastAddedID:parseInt(g),form:mag.data.content,magid:mag.isedit,isShow:""}),a.$storage.magid!=mag.isedit&&(a.$storage.showmagazineset=!0,a.$storage.lastAddedID=parseInt(g),a.$storage.form=mag.data.content,a.$storage.magid=mag.isedit,a.$storage.isShow="")}else mag.isact?a.$storage=b.$default({showmagazineset:!0,lastAddedID:a.act[mag.act_type].length,form:{type:a.actname[mag.act_type],paddingt:"0px",paddingr:"0px",paddingb:"0px",paddingl:"0px",styles:a.styles[mag.act_type],rules:a.rules,form_fields:a.act[mag.act_type]},isShow:""}):a.$storage=b.$default({showmagazineset:!0,lastAddedID:0,form:{type:"magazine",bgcolor:a.color.bgcolor,paddingt:"0px",paddingr:"0px",paddingb:"0px",paddingl:"0px",share:{shareimg:"",sharetitle:"",sharecontent:""},form_fields:[]},isShow:""});if(a.$storage.form)for(var h=0;h<a.$storage.form.form_fields.length;h++){var i=a.$storage.form.form_fields[h];"richtxt"==i.field_type&&(i.field_richcon=decodeURIComponent(i.field_richcon))}a.clearsession=function(){a.$storage.$reset()},window.onunload=function(){localStorage.removeItem("ueditor_preference")},a.addNewField=function(b){for(var c=0,e=0;e<a.$storage.form.form_fields.length;e++)a.$storage.form.form_fields[e].field_type==b&&c++;if(1==c&&("carousel"==b||"notice"==b||"contact"==b||"time"==b||"menu"==b||"share"==b||"form"==b||"qrcode"==b))return mag.showtips("该模块只能添加一个"),!1;a.$storage.lastAddedID++,a.showcurrentitem(b,a.$storage.lastAddedID);var f=d.addfield(b,a.$storage.lastAddedID);a.$storage.form.form_fields.push(f),mag.scrollbottom()},a.showcurrentitem=function(b,c){a.$storage.isShow=b+c,a.$storage.showmagazineset=!1},a.IsdeleteField=function(b,c,d){a.clientX=b.clientX-150+"px",a.clientY=b.clientY-66+"px",a.showdelmodal=!0,a.del_id=c},a.cancledeleteField=function(){a.del_id="",a.clientX="0px",a.clientY="auto",a.showdelmodal=!1},a.deleteField=function(){for(var b=a.$storage.form.form_fields,c=0;c<b.length;c++)if(b[c].field_id==a.del_id){if(c-1>=0)var d=b[c-1].field_id,e=b[c-1].field_type;else if(c+1<b.length)var f=b[c+1].field_id,g=b[c+1].field_type;d?a.showcurrentitem(e,d):f?a.showcurrentitem(g,f):a.showsetmagazine(),b.splice(c,1),a.clientX="0px",a.clientY="auto",a.showdelmodal=!1;break}},a.showsetmagazine=function(){a.$storage.showmagazineset=!0,a.$storage.isShow=""},a.sortableOptions={axis:"y",stop:function(a,b){}},a.upmove_modal=function(a,b){d.upmove_modal(a,b)},a.downmove_modal=function(a,b){d.downmove_modal(a,b)},a.resetcolor=function(b,c,d){if("form"==b)a.$storage.form[c]=d;else if("act"==b)a.$storage.form.styles[c]=d;else if(b[c]=d,"dazhuanpan"==b.field_type){var e=[b.field_bgcolor1,b.field_bgcolor2];wheelfunc.draw(e,b.field_color)}},a.changetitlecolor=function(a,b){a.field_color=b},a.addcarouselimg=function(a){d.addcarouselimg(a)},a.del_carousel=function(a,b){d.del_carousel(a,b)},a.selectprdtheme=function(b){a.$broadcast("selectprdtheme"),a.$on("confirmprdtheme",function(a,c,d){b.field_themetitle=d,b.field_prdtheme=c})},a.addmenu_nav=function(a){d.addmenu_nav(a)},a.del_nav=function(a,b){d.del_nav(a,b)},a.menu_restoreicon=function(a){a.nav_imgurl=""},a.show_menusetimg=function(a){return d.show_menusetimg(a)},a.confirmitem=function(a){a.field_items=overall_array,"product"==a.field_type&&(a.field_prdids=prdselected_ids),overall_array.length%2==0?a.field_class="prd_odd":a.field_class="prd_even"},a.ready=function(b){a.ueditor=b},a._simpleConfig=d.richConfig,a.creat_videohtml=function(a,b){var c=b.field_url,d=$(a.target).parent().next(".info");if(!c)return d.html("请输入连接"),setTimeout(function(){d.html("")},"3000"),!1;var e=video.buildvideo(c,"320",d);b.field_video=encodeURIComponent(e)},a.getforminfo=function(a,b){b.field_formid=$(a.target).attr("data-id"),b.field_formcon=encodeURIComponent(overall_html)},a.creatpuzzleimgs=function(a,b){var c=$(a.target).prev().find(".magictable"),d=c.find("td.empty").length,e=c.find("td.notempty").length,f=c.find("td.notempty.hasimg").length;if(d>0)return mag.showtips("请将拼图布局完成，不能有空格区域"),!1;if(e!==f)return mag.showtips("图片不能为空，请将图片选择完成"),!1;var g='<table class="magictable">'+c.html()+"</table>";g=g.replace(/<div([\s\w=\">\<-]*[\W]*){4}(\/div>){1}/g,""),b.field_puzzlecon=encodeURIComponent(g)},a.changedzptheme=function(a,b){e.changedzptheme(a,b)},a.changeshaketheme=function(a,b){e.changeshaketheme(a,b)},a.delprize=function(a,b){e.delprize(a,b)},a.addprize=function(a){e.addprize(a)},a.changeprize=function(a){"2"==a.type?a.award={type:"code",value:""}:"6"==a.type?a.award={type:"sign",value:""}:a.award=""},a.confirmprize=function(a){a.award=overall_obj},a.confirmlabel=function(a,b){b.id=$(a.target).attr("key"),b.name=$(a.target).attr("str")},a.clicklock=0,a.savemagazine=function(){if(a.clicklock)return!1;a.clicklock=1;a.$storage.form;f.savemagazine(a)},a.previewmagazine=function(){f.previewmagazine(a)},a.confirm_preview=function(){f.confirm_preview(a,c)}}]),myApp.controller("modalnavCtr",["$scope","$rootScope",function(a,b){a.navtype="txtmodals",a.showmodalnav=function(b){a.navtype=b}}]),myApp.controller("viewCtr",["$scope","$rootScope",function(a,b){}]),myApp.controller("editCtr",["$scope","$rootScope",function(a,b){}]),myApp.controller("productCtr",["$scope","ProductService",function(a,b){a.showprdtheme=!1,a.$on("selectprdtheme",function(c){a.showprdtheme=!0,a.prdthemetitle||(a.prdthemetitle=b.prdthemetitle)}),a.confirmprdtheme=function(b,c){a.showprdtheme=!1,a.$emit("confirmprdtheme",b,c)},a.closeprdtheme=function(){a.showprdtheme=!1}}]);var video={trim:function(a){return a.replace(/(^\s*)|(\s*$)/g,"")},qq_handler:function(a,b,c){var d,e="",f=/^http:\/\/v\.qq\.com\/(boke\/)?page\/[a-z0-9]\/[a-z0-9]\/[a-z0-9]\/([a-z0-9_=\-]+)/i,g=/^http:\/\/v\.qq\.com\/prev\/[a-z0-9]\/([a-z0-9_=\-]+)\/([a-zA-Z0-9_=\-]+)/i,h=/^http:\/\/v\.qq\.com\/cover\/[a-z0-9]\/([a-z0-9_=\-]+)\/([a-zA-Z0-9_=\-]+)/i,i=/^http:\/\/v\.qq\.com\/cover\/[a-z0-9]\/[a-z0-9]+\.html[?]vid=([a-z0-9]+)/i;if(d=f.test(a)?f.exec(a):g.test(a)?g.exec(a):h.test(a)?h.exec(a):i.test(a)?i.exec(a):"")for(var j=0;j<d.length;j++)e=d[d.length-1];else e="";if(e)var k='<iframe class="videoiframe" scrolling="no" allowfullscreen src="http://v.qq.com/iframe/player.html?vid='+e+"&amp;width="+b+"&height="+c+'&auto=0" data-url="'+a+'" width="'+b+'" height="'+c+'" frameborder="0"></iframe>';else var k="";return k},youku_handler:function(a,b,c){var d="",e=/^http:\/\/v\.youku\.com\/v_show\/id_([a-z0-9_=\-]+)\.html/i;if(e.test(a))for(var f=e.exec(a),g=0;g<f.length;g++)d=f[f.length-1];else d="";if(d)var h='<iframe class="videoiframe" scrolling="no" data-url="'+a+'" allowfullscreen src="http://player.youku.com/embed/'+d+'" width="'+b+'" height="'+c+'" frameborder="0"></iframe>';else var h="";return h},tudou_handler:function(a,b,c){var d="",e=/^http:\/\/www\.tudou\.com\/(listplay|albumplay|programs)\/[a-z0-9_=\-]+\/([a-z0-9_=\-]+)/i;if(e.test(a))for(var f=e.exec(a),g=0;g<f.length;g++)d=f[f.length-1];else d="";if(d)var h='<iframe class="videoiframe" scrolling="no" allowfullscreen src="http://www.tudou.com/programs/view/html5embed.action?code='+d+'" width="'+b+'" height="'+c+'" data-url="'+a+'" frameborder="0"></iframe>';else var h="";return h},buildvideo:function(a,b,c){a=video.trim(a);var d=[],e="";d.qq="qq.com",d.youku="youku.com",d.tudou="tudou.com";var b=b,f=Math.ceil(3*b/4);if(!a)return c.html("请输入连接"),setTimeout(function(){c.html("")},"3000"),!1;for(var g in d)-1!==a.indexOf(d[g])&&(e=g);if(""==e)return c.html("请输入正确的连接"),setTimeout(function(){c.html("")},"3000"),!1;switch(e){case"qq":htmlval=video.qq_handler(a,b,f);break;case"youku":htmlval=video.youku_handler(a,b,f);break;case"tudou":htmlval=video.tudou_handler(a,b,f);break;default:htmlval=""}return htmlval?htmlval:(c.html("不支持此视频或者视频连接错误"),setTimeout(function(){c.html("")},"3000"),!1)}};myApp.directive("resizable",function(){return{restrict:"A",link:function(a,b,c){for(var d=a.$storage.form.form_fields,e=0;e<d.length;e++)d[e].field_id==c.count&&d[e].field_puzzlecon&&resizable_location(b);$(b).resizable({grid:100,containment:".magic_container",maxWidth:400,maxHeight:400,minWidth:100,minHeight:100,cancel:".notempty",start:function(a,c){resizestart(b,a,c)},stop:function(a,c){resizestop(b,a,c)}}),$(b).dblclick(function(){var a=$(b).css("width"),c=$(b).css("height"),d=$(b).css("left"),e=$(b).css("top"),a=a.substr(0,1),c=c.substr(0,1),d=d.substr(0,1),e=e.substr(0,1),f=160*parseInt(a),g=160*parseInt(c),h=parseInt(a)+parseInt(d),i=parseInt(c)+parseInt(e),j=$(b).prev().find(".notempty").length;j&&(j=j),$(b).prev().find(".empty").each(function(){var b=$(this).data("x"),k=$(this).data("y");if(h>b&&b>=d&&k>=e&&i>k)if(b==d&&k==e){var l="<div class='magic_btns'><span class='edit_magicurl selecturl' data-mark='backurl' type='magic' title='选择链接'></span><span class='edit_magicimg selectimage' data-mark='magic' title='选择图片'></span><span class='del_magic' title='删除'></span></div>";$(this).attr({rowspan:c,colspan:a,"data-notempty":j}).addClass("notempty notempty_"+j+" rows_"+c+" cols_"+a).removeClass("empty").html("<span>最佳尺寸</br>"+f+"px*"+g+"px</span><a href='javascript:void(0);'><img src=''></a>"+l)}else $(this).remove()}),resizable_location(b)})}}}),$(".del_magic").live("click",function(){var a=this.parentNode.parentNode,b=a.parentNode,c=(b.rowIndex,a.cellIndex,$(this).parents(".notempty")),d=c.data("x"),e=c.data("y"),f=c.attr("colspan"),g=c.attr("rowspan"),h=parseInt(f)+d,k=parseInt(g)+e,l=$(".magic_container").find(".magictable");for(i=e;i<k;i++){var m="",n=l.find("tr:nth-child("+(i+1)+")"),o=0,p=0;for(j=d;j<h;j++)m+="<td class='empty' data-x='"+j+"' data-y='"+i+"'></td>";$(m).each(function(){var a=$(this).attr("data-x"),b=$(this).attr("data-y");l.find("[data-y="+i+"]").each(function(){var b=$(this).data("x");a>=b&&$(this).hasClass("empty")&&(o+=1),a>=b&&$(this).hasClass("notempty")&&(p+=1)});var c=n.find(".empty[data-x="+a+"][data-y="+b+"]").length;1>c&&(o>p?n.find("td:nth-child("+o+")").after(m):p>o?n.find("td:nth-child("+p+")").after(m):p+o==0?n.prepend(m):n.find("td:nth-child("+(p+o)+")").after(m))})}var q=c.data("notempty");c.remove(),l.find(".notempty").each(function(){var a=$(this).attr("data-notempty");a>q&&($(this).removeClass("notempty_"+a),a-=1,$(this).attr("data-notempty",a).addClass("notempty_"+a))}),resizable_location("#resizable")}),myApp.directive("magictable",function(){return{restrict:"A",link:function(a,b,c){$(b).find(".notempty").live("hover",function(a){"mouseenter"==a.type?$(this).find(".magic_btns").addClass("show"):$(this).find(".magic_btns").removeClass("show")}),$(b).find(".notempty a").live("click",function(a){a.preventDefault()})}}});